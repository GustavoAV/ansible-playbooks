# https://www.virtualbox.org/wiki/Linux_Downloads
---
- name: Setup VirtualBox
  hosts: all
  become: true
  vars:
    vbox_version: 7.2

  tasks:
    - name: Add repository (Debian)
      ansible.builtin.include_tasks:
        file: tasks/add_debian_repo.yml
      vars:
        debrepo_gpg_key_url: https://www.virtualbox.org/download/oracle_vbox_2016.asc
        debrepo_gpg_key_path: /usr/share/keyrings/oracle-virtualbox-2016.gpg
        debrepo_string: >-
          deb [arch={{ debrepo_dpkg_arch.stdout }} signed-by={{ debrepo_gpg_key_path }}]
          https://download.virtualbox.org/virtualbox/debian {{ debrepo_distro_codename.stdout }} contrib
      when: ansible_facts['os_family'] == "Debian"

    - name: Add repository (RedHat)
      ansible.builtin.get_url:
        url: https://download.virtualbox.org/virtualbox/rpm/{{ vbox_redhat_repo }}/virtualbox.repo
        dest: /etc/yum.repos.d/virtualbox.repo
        mode: "0644"
      vars:
        vbox_redhat_repo: "{% if ansible_facts['distribution'] == \"Fedora\" %}fedora{% else %}el{% endif %}"
      when: ansible_facts['os_family'] == "RedHat"

    - name: Install VirtualBox (Debian)
      ansible.builtin.apt:
        name: virtualbox-{{ vbox_version }}
        state: present
        update_cache: true
        cache_valid_time: 3600
      when: ansible_facts['os_family'] == "Debian"

    - name: Install VirtualBox (RedHat)
      ansible.builtin.dnf:
        name: VirtualBox-{{ vbox_version }}
        state: present
        update_cache: true
      when: ansible_facts['os_family'] == "RedHat"

    - name: Validate install
      ansible.builtin.command:
        cmd: vboxmanage --version
      changed_when: false
